---
title: "Plot Incucyte Drug Curves"
author: "Jessica Bade"
date: "11/15/2021"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
require(remotes)

if(!require(mpnstXenoModeling)){
  remotes::install_github('sgosline/mpnstXenoModeling')
  library(mpnstXenoModeling)
}
#remotes::install_github('https://github.com/chapmandu2/IncucyteDRC')

library(data.table)
library(dplyr)
library(repr)
library(pheatmap)
library(ggplot2)
library(drc)
library(pROC)
library(tidyr)
```

```{r}
mpnstXenoModeling::loadPDXData()
```

```{r}
icyteData<-tidyr::unite(icyteData, "compound_name", c(experimentalCondition,dosage,synid,replicate),na.rm=TRUE,remove=FALSE)
treatTab <- icyteData[icyteData$experimentalCondition != 'DMSO',]
contTab <- icyteData[icyteData$experimentalCondition == 'DMSO',]
```

### Analysis of IncuCyte % confluence

```{r}
icStats0 <- treatTab%>%
            mutate(maxKilling = (response/100))
minDrugs <- icStats0%>%
            mutate(hasRNASeq=(model_system_name%in%rnaSeq$Sample))%>%
            group_by(compound_name)%>%
            summarise(samples=n_distinct(model_system_name),samplesWithRNA=count(hasRNASeq==TRUE))%>%
            subset(samples>2)
#DT::datatable(minDrugs)
icStats0<-tidyr::unite(icStats0,'Drug',c(experimentalCondition,dosage))
```

```{r}
spi.mat<-icStats0%>%
  dplyr::select(Drug,model_system_name,maxKilling)%>%
  group_by(Drug,model_system_name)%>%
  summarise(maxKilling=max(maxKilling))%>%
  tidyr::pivot_wider(values_from=maxKilling,names_from=model_system_name)%>%#,values_fill=list(maxKilling=0))%>%
  tibble::column_to_rownames('Drug')%>%
  as.matrix()
spi.mat
pheatmap(spi.mat,cellwidth = 10,cellheight=10,main='max killing across Incucyte data')
#pheatmap(spi.mat,cellwidth = 10,cellheight=10,main='max killing across Incucyte data',filename='MK_ic.png')



```

```{r}
##let's plot the stats for each drug
icStats<-merge(meta.dt,icyteData%>%
               dplyr::select(model_system_name, experimentalCondition, compound_name, dosage)%>%
               distinct(),
               by=c('compound_name','model_system_name', 'dosage'))
icStats<-tidyr::unite(icStats,'Drug',c(experimentalCondition,dosage))
icStats%>%dplyr::select(Drug)%>%distinct()
```

```{r}
auc.mat<-icStats%>%
  dplyr::select(Drug,model_system_name,auc)%>%
  aggregate(auc~Drug+model_system_name,data=.,mean)%>%
  tidyr::pivot_wider(values_from=auc,names_from=model_system_name)%>%#,values_fill=list(auc=0))#%>%
  tibble::column_to_rownames('Drug')%>%
  as.matrix()
auc.mat
pheatmap(auc.mat, cellwidth = 10,cellheight=10,main='AUC across Incucyte data')
```

```{r}
tgi.mat<-icStats%>%
  dplyr::select(Drug,model_system_name,ic50)%>%
  aggregate(ic50~Drug+model_system_name,data=.,mean)%>%
  tidyr::pivot_wider(values_from=ic50,names_from=model_system_name)%>%#,values_fill=list(ic50=0))#%>%
  tibble::column_to_rownames('Drug')%>%
  as.matrix()
tgi.mat
#pheatmap(tgi.mat,cellwidth = 10,cellheight=10,main='IC50 across Incucyte data',filename='ic50_ic.png')
pheatmap(tgi.mat,cellwidth = 10,cellheight=10,main='IC50 across Incucyte data')
```

```{r}

```
